!function(){function e(t,i,n){function o(a,r){if(!i[a]){if(!t[a]){var l="function"==typeof require&&require;if(!r&&l)return l(a,!0);if(s)return s(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var h=i[a]={exports:{}};t[a][0].call(h.exports,function(e){var i=t[a][1][e];return o(i||e)},h,h.exports,e,t,i,n)}return i[a].exports}for(var s="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}return e}()({1:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=e("./TeamworkApi"),r=function(){function e(){if(n(this,e),this.apiKeyStorageName="pokaApiKey",this.defaultStartSubUrl="/#/feed",this.defaultStartAsset="feed",this.onLoad=function(){cwidget.dispatchEvent("onLoad")},this._myFrame=document.getElementById("myFrame"),null!=this._myFrame){var t=this;this._myFrame.addEventListener("load",t.onLoad)}this._messagebox=document.getElementById("messagebox"),this._proxy=window.SmaCustomWidget.proxy,this._proxy.addOnReady(this._onReady.bind(this)),this._host=this._proxy.host,this._appName=null,this._credName=null,this._curAsset=null,this._defaultAsset=null}return s(e,[{key:"_onReady",value:function(){cwidget.on("TenantName",this._onAppNameChanged.bind(this)),cwidget.on("CredentialName",this._onCredentialNameChanged.bind(this)),widgetSDK.regCurrentAssetChange(this._onCurrentAssetChanged.bind(this))}},{key:"_onAppNameChanged",value:function(){this._appName=cwidget.TenantName,this._updateAppUrl()}},{key:"_onCredentialNameChanged",value:function(){this._credName=cwidget.CredentialName,this._updateAppUrl()}},{key:"_onCurrentAssetChanged",value:function(e){this._curAsset=widgetSDK.CurrentAsset||"",null==this._defaultAsset&&SmaCustomWidget.proxy.host.isOnPremise&&window.location.href&&window.location.href.toLowerCase().indexOf("file://")<0&&null!=window.SmaCustomWidget.currentPageUrl&&window.SmaCustomWidget.currentPageUrl.toLowerCase().indexOf("file://")<0&&(this._defaultAsset=this._curAsset),this._updateAppUrl()}},{key:"_updateAppUrl",value:function(){if(null!=this._appName&&null!=this._curAsset&&!(window.location.href&&window.location.href.toLowerCase().indexOf(this._appName.toLowerCase())<0&&window.location.href.toLowerCase().indexOf("index.html")<0)){var e=this._getPokaBaseUrl(this._appName);this._api=this._api||new a.TeamworkApi(e);this._api.checkLogonStatus(function(t){if(!t||!t.inProgress){var i=this._isHomeUrl(window.location.href)&&this._curAsset!=this.defaultStartAsset;!i&&(t.inProgress||t.isLoggedOn)&&window.location.href.indexOf("file://")<0&&this._curAsset==this._defaultAsset&&!this._hasChangeFromPoka()||(window.location&&window.location.href&&window.location.href.toLowerCase().indexOf(e.toLowerCase())<0?(this._defaultAsset=this._curAsset,this.onUrlChange(e)):this._getUserNameAndPassword(function(t){this._api.logon(t.user,t.password,function(t){var i=function(t,i){this._api=this._api||new a.TeamworkApi(this._getPokaBaseUrl(this._appName),t),this._getEquipmentId(this._curAsset,function(t){e=null==t?null:this._getPokaUrl(this._appName)+"equipments/"+t,this._defaultAsset=this._curAsset,e?this.onUrlChange(e,i):i&&window.location.reload()}.bind(this))}.bind(this);t&&t.api_key?i(t.api_key,t.forceReload):this._api.monitorOnGetApiKey(function(e){i(e,!0)}.bind(this))}.bind(this))}.bind(this)))}}.bind(this))}}},{key:"_getEquipmentList",value:function(e,t){if(this._cached_EquipmentInfo&&!t)e&&e(this._cached_EquipmentInfo);else{var i=this._api;i.listAllEquipments(function(t){null==t?e&&e(null):(this._cached_EquipmentInfo=t,e&&e(t))}.bind(this))}}},{key:"_getEquipmentId",value:function(e,t,i){this._getEquipmentList(function(i){if(null==i)t&&t(null);else{for(var n=0;n<i.results.length;n++){var o=i.results[n];if(o&&o.description&&o.description.toLowerCase()==e.toLowerCase())return void(t&&t(o.id))}t&&t(null)}}.bind(this),i)}},{key:"_isHomeUrl",value:function(e){return null==e?!1:(e=e.toLowerCase(),e="/"==e[e.length-1]?e.substr(0,e.length-1):e,0==e.indexOf(this._getPokaBaseUrl(this._appName).toLowerCase())&&e.indexOf(this.defaultStartSubUrl)==e.length-this.defaultStartSubUrl.length)}},{key:"_hasChangeFromPoka",value:function(){return window.location.href.indexOf("file://")<0&&window.SmaCustomWidget.currentPageUrl.toLowerCase()!=window.location.href.toLowerCase()?!0:!1}},{key:"_getPokaBaseUrl",value:function(e){return"https://"+e+".poka.io"}},{key:"_getPokaUrl",value:function(e){return this._getPokaBaseUrl(e)+"/app/#/"}},{key:"_getUserNameAndPassword",value:function(e,t){var i=this._credName;return t||null!=i&&""!=i?i&&""!=i&&"<None>"!=i?void window.widgetSDK.GetNamedCredentials(i,function(t){var i=null,n=null,s="string"==("undefined"==typeof t?"undefined":o(t)).toLowerCase()?JSON.parse(t):t;if(s)for(var a=0;a<s.length;a++){var r=s[a];if(r.Key&&"username"==r.Key.toLowerCase()?i=r.Value:r.Key&&"password"==r.Key.toLowerCase()&&(n=r.Value),i&&n)break}var l={user:i,password:n};e&&e(l)}):void(e&&e({})):void this._waitUntil(function(t){this._getUserNameAndPassword(e,!0)}.bind(this),function(){null!=this._credName&&""!=this._credName}.bind(this),2e3)}},{key:"onUrlChange",value:function(e,t){e=e.replace("\\","/").toLowerCase();var i=SmaCustomWidget.proxy.host.isOnPremise;if(i)e.indexOf("://")<0&&(e="http://"+e),(null==window.SmaCustomWidget.currentPageUrl||window.SmaCustomWidget.currentPageUrl.toLowerCase()!=e.toLowerCase()||this._hasChangeFromPoka())&&(t?(window.location.href=e,window.location.reload()):window.location.href=e,window.SmaCustomWidget.currentPageUrl=e);else{var n=window.location.href.toLowerCase();if(e.indexOf("://")<0&&(n.indexOf("file://")>=0?e="file://"+e:0==n.indexOf("https:")?e="https://"+e:0==n.indexOf("http:")&&(e="http://"+e)),!this._checkUrl(e))return void this._showMsg("URL is invalid.");var o=document.getElementById("tips_link");if(o.setAttribute("href",e),!this._checkUrlProtocolMatch(e)){var s="Mixed Content: The page at '{0}' was loaded over HTTPS, but requested an insecure frame '{1}'. This request has been blocked; the content must be served over HTTPS.";return s=s.replace("{0}",window.top.location.href).replace("{1}",e),void this._showMsg(s)}this._hideMsg(),(null==window.SmaCustomWidget.currentPageUrl||window.SmaCustomWidget.currentPageUrl.toLowerCase()!=e.toLowerCase()||this._hasChangeFromPoka())&&(this._myFrame.setAttribute("src",e),window.SmaCustomWidget.currentPageUrl=e)}}},{key:"_checkUrlProtocolMatch",value:function(e){var t=!1,i=window.location.href.toLowerCase();return i.indexOf("file:")>=0?t=!0:0==i.indexOf("https:")?0==e.indexOf("https:")&&(t=!0):0==i.indexOf("http:")&&(t=!0),t}},{key:"_checkUrl",value:function(e){var t="(https?)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]",i=new RegExp(t);return i.test(e)}},{key:"_showMsg",value:function(e){this._myFrame.style.display="none",this._messagebox.style.display="",this._messagebox.innerHTML(e)}},{key:"_hideMsg",value:function(){this._myFrame.style.display="",this._messagebox.style.display="none"}},{key:"_waitUntil",value:function(e,t,i,n){if(i=i||5e3,!t||t())return void(e&&e(!0));if(n){if(n.startTime&&Date.now()-n.startTime>i)return void(e&&e(!1))}else n={startTime:Date.now()};window.setTimeout(this._waitUntil.bind(this,e,t,i,n),250)}}]),e}();new r},{"./TeamworkApi":2}],2:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();i.TeamworkApi=function(){function e(t,i){n(this,e),this._API_KEY_STORAGE_NAME="pokaApiKey",this._API_INVALID_KEY="<$InvalidKey$>",this._API_LIST_ALL_EQUIPMENTS="/api/v2.2/equipments/",this._API_LOGON="/api/v2.2/authentication/login",this._API_GET_PERMISSION="/api/v2.2/authentication/permissions/?__appNoMessage=true",("/"==t[t.length-1]||"\\"==t[t.length-1])&&(t=t.substring(0,t.length-1)),this._apiBaseUrl=t,this._apiKey=i,console.log("[TeamworkApi] Server Base Url: "+this._apiBaseUrl)}return o(e,[{key:"checkLogonStatus",value:function(e,t){this._apiKey=this._apiKey||localStorage.getItem(this._API_KEY_STORAGE_NAME),this._isLogon||this._checkLogonStatusInProgress||this._isLogging||!this._verifyKey()?(this._checkLogonStatusInProgress||this._isLogging)&&e?this._waitUntil(function(t){t&&e?e({api_key:this._getApiKey(),isLoggedOn:this._isLogon}):!t&&e&&e({api_key:null,isLoggedOn:!1,inProgress:!0})}.bind(this),function(){return!this._checkLogonStatusInProgress&&!this._isLogging}.bind(this),t):this._isLogon&&this._verifyKey()&&e?e({api_key:this._getApiKey(),isLoggedOn:this._isLogon}):e&&e({api_key:null,isLoggedOn:!1}):(console.log("[TeamworkApi] Check API Key..."),this._checkLogonStatusInProgress=!0,this._request(this._API_GET_PERMISSION,null,null,function(t){this._checkLogonStatusInProgress=null,null!=t?(console.log("[TeamworkApi] API Key is valid."),this._isLogon=!0):(console.log("[TeamworkApi] API Key invalid."),this._apiKey=this._API_INVALID_KEY),e&&e({api_key:this._getApiKey(),isLoggedOn:this._isLogon})}.bind(this)))}},{key:"logon",value:function(e,t,i){if(null==e||null==t)return this._apiKey=this._apiKey||localStorage.getItem(this._API_KEY_STORAGE_NAME),void(i&&i({api_key:this._getApiKey()}));{if(this._isLogon||this._isLogging)return this._isLogon?(this._apiKey=this._apiKey||localStorage.getItem(this._API_KEY_STORAGE_NAME),void(i&&i({api_key:this._getApiKey()}))):void 0;console.log("[TeamworkApi] Automatically logon..."),this._isLogging=!0;try{var n={username:e,password:t};this._apiKey=this._API_INVALID_KEY,this._request(this._API_LOGON,n,"POST",function(e){e&&null!=e.api_key&&""!=e.api_key?(console.log("[TeamworkApi] Automatically logged on."),this._isLogon=!0,this._isLogging=null,this._apiKey=e.api_key,localStorage.setItem(this._API_KEY_STORAGE_NAME,this._apiKey),e.forceReload=!0,i(e)):i&&(this._isLogging=null,i(null))}.bind(this))}catch(o){console.log(o),this._isLogging=null}}}},{key:"listAllEquipments",value:function(e){return this._request(this._API_LIST_ALL_EQUIPMENTS,null,null,e)}},{key:"monitorOnGetApiKey",value:function(e,t){if(!this._isMonitoringOnGetApiKey){if(this._isLogon)return void(e&&e(this._apiKey));if(!this._isLogging||t){console.log("[TeamworkApi] Start monitoring API key changing..."),this._isMonitoringOnGetApiKey=!0;var i=localStorage.getItem(this._API_KEY_STORAGE_NAME);this._waitUntil(function(i){this._isMonitoringOnGetApiKey=null,console.log("[TeamworkApi] Stop monitoring API key changing."),i&&(t||!this._isLogging&&!this._isLogon)&&this.checkLogonStatus(function(t){e&&e(t?t.api_key:null)}.bind(this))}.bind(this),function(){return!t&&(this._isLogon||this._isLogging)||localStorage.getItem(this._API_KEY_STORAGE_NAME)!=i}.bind(this),21e7)}}}},{key:"_verifyKey",value:function(){return null!=this._apiKey&&""!=this._apiKey&&this._apiKey!=this._API_INVALID_KEY}},{key:"_getApiKey",value:function(){return this._verifyKey()?this._apiKey:null}},{key:"_request",value:function(e,t,i,n,o){if(window.fetch&&!o){var s={headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},method:i||"GET"};return this._verifyKey()&&(s.headers.Authorization="ApiKey "+this._getApiKey()),null!=t&&"GET"!=i&&"HEAD"!=i&&null!=i&&(s.body=JSON.stringify(t)),fetch(this._apiBaseUrl+e,s).then(function(e){return 200==e.status?e.json():void(n&&n(null))}).then(function(e){e&&n&&n(e)})["catch"](function(e){n&&n(null),console.log(e)})}try{var a=new XMLHttpRequest;a.open(i||"GET",this._apiBaseUrl+e),this._verifyKey()&&a.setRequestHeader("authorization","ApiKey "+this._getApiKey()),a.setRequestHeader("content-type","application/json"),a.setRequestHeader("accept","application/json, text/plain"),a.send(JSON.stringify(t)),a.onload=function(){200==a.status&&a.response&&n?n(JSON.parse(a.response)):n&&n(null)}}catch(r){n&&n(null),console.log(r)}}},{key:"_waitUntil",value:function(e,t,i,n){if(i=i||5e3,!t||t())return void(e&&e(!0));if(n){if(n.startTime&&Date.now()-n.startTime>i)return void(e&&e(!1))}else n={startTime:Date.now()};window.setTimeout(this._waitUntil.bind(this,e,t,i,n),250)}}]),e}()},{}]},{},[1]);